#### summary 
#### recipe that runs the Autoassess Conservation assessment area diagnostic
#### Version1: 6 June 2018 (D-Day); updated version: 11 September 2018
#################
#### Description:
#################
# The original conservation diagnostic from autoassess accepts two input UM suites; this has now been
# changed for ESMValTool to two models; the recipe can accomodate as many pairs of models to be compared as the 
# user needs; this is handled in the diagnostics//scripts: while the script is the same
# (autoassess_conservation.py), the (control_model, exp_model) pair may vary accoding to the user's
# needs. Different (start, end) dates can also be specified (in autoassess format: YYYY/MM/DD) per run, as long as the
# time data is within the (start_year, end_year) specified in models: section. Preprocessing is basic; 
# regridding only at the moment; this is done once.
#################
#### CAVEATS
#################
# - There are about 60% of original Autoassess variables that are not requested for and used in this
#   recipe - this needs to be done!
#################
# RECIPE IS NOT FULLY WORKING
###########################################################################################################
---

datasets:
  - {dataset: MPI-ESM-LR,  project: CMIP5,  exp: amip,  ensemble: r1i1p1,  start_year: 1995,  end_year: 2003}
  - {dataset: MPI-ESM-MR,  project: CMIP5,  exp: amip,  ensemble: r1i1p1,  start_year: 1995,  end_year: 2003}
  - {dataset: inmcm4,      project: CMIP5,  exp: amip,  ensemble: r1i1p1,  start_year: 1995,  end_year: 2003}

preprocessors:
  pp_aa_area:
    # this diag suite does not need plev selection
    # do not implement it since most of the vars dont
    # have plevs
    regrid:
      target_grid: MPI-ESM-LR
      scheme: linear

diagnostics:
  aa_cons:
    description: Autoassess test diag for Conservation.
    # identified by 28 June 2018: [rsdt, rsut, rsds?, rlds?, rlut, hfss, prsn, pr]
    variables:
      rsdt:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      rsut:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      rsds:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      rlds:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      rlut:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      hfss:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      prsn:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      pr:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      #sbl:
      #  variable very hard to find
      #  preprocessor: pp_aa_area
      #  mip: Amon
      #  field: T3M
      evspsbl:
        preprocessor: pp_aa_area
        mip: Amon
        field: T3M
      mrros:
        preprocessor: pp_aa_area
        mip: Lmon
        field: T2Ms
    ##################
    # No OBS for now
    # additional_datasets:
    #   - {dataset: ERA-Interim,  project: OBS,  type: reanaly,  version: 1,  start_year: 2000,  end_year: 2002,  tier: 3}
    ##################
    scripts:
      autoassess_cons_test_1: &autoassess_cons_test_1_settings
        script: autoassess/autoassess_area_base.py
        title: "Autoassess Conservation Diagnostic Metric MPI-MPI"
        area: conservation
        control_model: MPI-ESM-LR
        exp_model: MPI-ESM-MR
        obs_models: []
        # note that there is annual averaging done
        # so dont choose a single year only
        start: 1996/12/01
        end: 2002/12/01 
      autoassess_cons_test_2: &autoassess_cons_test_2_settings
        script: autoassess/autoassess_area_base.py
        title: "Autoassess Conservation Diagnostic Metric MPI-INM"
        area: conservation
        control_model: MPI-ESM-LR
        exp_model: inmcm4
        obs_models: []
        # note that there is annual averaging done
        # so dont choose a single year only
        start: 1996/12/01
        end: 2002/12/01

  plot_standard:
    description: Wrapper to collect and plot previously calculated metrics
    scripts:
      plot_cons_test_1: &plot_cons_test_1_settings
        <<: *autoassess_cons_test_1_settings
        control_model: MPI-ESM-LR
        exp_model: MPI-ESM-MR
        obs_models: [ERA-Interim]
        script: autoassess/plot_autoassess_metrics.py
        ancestors: ['*/autoassess_cons_test_1']
        title: "Plot Conservation Metrics MPI-MPI"
        plot_name: "Conservation_Metrics"
        diag_tag: aa_cons
        diag_name: autoassess_cons_test_1
      plot_cons_test_2: &plot_cons_test_2_settings
        <<: *autoassess_cons_test_2_settings
        control_model: MPI-ESM-LR
        exp_model: inmcm4
        obs_models: [ERA-Interim]
        script: autoassess/plot_autoassess_metrics.py
        ancestors: ['*/autoassess_cons_test_2']
        title: "Plot Conservation Metrics MPI-MPI"
        plot_name: "Conservation_Metrics"
        diag_tag: aa_cons
        diag_name: autoassess_cons_test_2
